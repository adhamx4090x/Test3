name: Unzip Files and Flatten Repo

on:
  push:
    paths:
      - '**.zip'

permissions:
  contents: write

jobs:
  unzip-and-flatten:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract ZIP files safely
        run: |
          set -euo pipefail
          shopt -s dotglob
          for zip_file in *.zip; do
            [ -f "$zip_file" ] || continue
            TEMP_DIR=$(mktemp -d)
            unzip -o -q "$zip_file" -d "$TEMP_DIR"

            # تجاهل أي _workflows
            rm -rf "$TEMP_DIR/.github/_workflows" || true

            FILES=$(find "$TEMP_DIR" -mindepth 1 -maxdepth 1 -print)
            for item in $FILES; do
              cp -r "$item" .
            done

            rm -rf "$TEMP_DIR"
            rm -f "$zip_file"
          done
          shopt -u dotglob

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push
        run: |
          if git status --porcelain | grep -q .; then
            git add -A
            git commit -m "Extract ZIP contents"
            git push
          else
            echo "No changes"

      - name: Delete this workflow file
        if: always()
        run: |
          rm -f .github/workflows/unzip-flatten.yml
          if [ -d .github/workflows ] && [ -z "$(ls -A .github/workflows 2>/dev/null)" ]; then
            rmdir .github/workflows || true
          fi
