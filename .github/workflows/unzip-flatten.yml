name: Unzip Files and Flatten Repo

on:
  push:
    paths:
      - '**.zip'

permissions:
  contents: write
  workflows: write

jobs:
  unzip-and-flatten:
    runs-on: ubuntu-latest

    steps:
      - name: Backup workflow file
        run: |
          mkdir -p /tmp/backup
          if [ -f .github/workflows/unzip-flatten.yml ]; then
            cp .github/workflows/unzip-flatten.yml /tmp/backup/
            echo "WORKFLOW_EXISTS=true" >> $GITHUB_ENV
          else
            echo "WORKFLOW_EXISTS=false" >> $GITHUB_ENV
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Extract ZIP files and flatten structure
        run: |
          set -euo pipefail
          shopt -s dotglob
          while IFS= read -r -d '' zip_file; do
            echo "Processing: $zip_file"
            TEMP_DIR=$(mktemp -d)
            trap "rm -rf '$TEMP_DIR'" EXIT

            # Extract ZIP file
            unzip -o -q "$zip_file" -d "$TEMP_DIR"

            # Rename .github to .github-extracted if exists (to avoid conflicts)
            if [ -d "$TEMP_DIR/.github" ]; then
              echo "Renaming .github to .github-extracted to avoid conflicts"
              mv "$TEMP_DIR/.github" "$TEMP_DIR/.github-extracted"
            fi

            cd "$TEMP_DIR"
            if [ "$(find . -maxdepth 1 -type f | wc -l)" -gt 0 ]; then
              cd "$OLDPWD"
              cp -r "$TEMP_DIR"/* .
            else
              FIRST_LEVEL_DIRS=$(find . -maxdepth 1 -type d | tail -n +2)
              if [ "$(echo "$FIRST_LEVEL_DIRS" | wc -l)" -eq 1 ]; then
                TOP_DIR=$(find . -maxdepth 1 -type d | tail -n +2 | head -1)
                cd "$OLDPWD"
                cp -r "$TEMP_DIR/$TOP_DIR"/* .
              else
                cd "$OLDPWD"
                cp -r "$TEMP_DIR"/*/ .
              fi
            fi
            rm -f "$zip_file"
            echo "Completed: $zip_file"
          done < <(find . -maxdepth 1 -type f -name "*.zip" -print0)
          shopt -u dotglob

      - name: Delete workflow file only
        if: env.WORKFLOW_EXISTS == 'true'
        run: |
          rm -f .github/workflows/unzip-flatten.yml
          if [ -d .github/workflows ] && [ -z "$(ls -A .github/workflows 2>/dev/null)" ]; then
            rmdir .github/workflows 2>/dev/null || true
          fi

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for changes
        id: git-status
        run: |
          if git status --porcelain | grep -q .; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.git-status.outputs.has_changes == 'true'
        run: |
          git add -A
          git commit -m "Extract and flatten ZIP contents - $(date '+%Y-%m-%d %H:%M:%S')"
          git push

      - name: No changes to commit
        if: steps.git-status.outputs.has_changes == 'false'
        run: |
          echo "No files to process"

      - name: Cleanup backup
        if: always()
        run: |
          rm -rf /tmp/backup
